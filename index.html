<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTKA Pro - Ujian Online</title>
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Agar browser mengerti kode React/JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase SDK (Database) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- 5. SheetJS (Excel Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Animasi Sederhana */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Scrollbar Halus */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Glassmorphism Effect */
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased selection:bg-indigo-100 selection:text-indigo-700">
    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBvA7rKjvM4V_mIItWdSYFFkhOd_wfoAzk",
            authDomain: "edutka-sekolah.firebaseapp.com",
            projectId: "edutka-sekolah",
            storageBucket: "edutka-sekolah.firebasestorage.app",
            messagingSenderId: "782604720482",
            appId: "1:782604720482:web:6826593654ab8b1b53b43b"
        };

        const isConfigured = !firebaseConfig.apiKey.includes("GANTI");
        let auth = null;
        let db = null;

        // Sanitasi App ID
        let appId = 'edutka-pro-v5';
        if (typeof __app_id !== 'undefined' && __app_id) {
             if (__app_id.includes('/')) appId = __app_id.split('/')[0];
             else appId = __app_id;
        }
        appId = appId.replace(/[^a-zA-Z0-9_-]/g, '_');

        if (isConfigured) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } catch (e) { console.error("Firebase init error:", e); }
        }
        
        const INITIAL_ADMIN = { username: 'admin', password: 'TKA*123456*', name: 'Administrator' };
        const { useState, useEffect, useMemo, useRef } = React;

        // --- KOMPONEN IKON SVG (Lebih Elegan) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                dashboard: <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"/>,
                file: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
                users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                logout: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>,
                chart: <g><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></g>,
                shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
                alert: <g><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></g>,
                check: <polyline points="20 6 9 17 4 12"/>,
                trending: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
                plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
                x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                refresh: <g><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></g>,
                trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
                loading: <g><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M18 12h4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 18v4"/><path d="m4.9 19.1 2.9-2.9"/><path d="M2 12h4"/><path d="m4.9 4.9 2.9 2.9"/></g>,
                book: <><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></>,
                clock: <circle cx="12" cy="12" r="10"/>,
                db: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10"/>}
                </svg>
            );
        };

        // --- SCREEN ERROR KONFIGURASI ---
        function ConfigErrorScreen() {
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white p-6">
                    <div className="max-w-2xl w-full bg-slate-800 rounded-xl p-8 shadow-2xl border border-slate-700 animate-fade-in">
                        <h1 className="text-3xl font-bold text-red-400 mb-4 flex items-center gap-2"><Icon name="alert" size={32}/> Konfigurasi Belum Selesai</h1>
                        <p className="text-lg mb-6 text-slate-300">
                            Silakan edit file <code className="bg-slate-950 px-2 py-1 rounded text-yellow-400 mx-1">index.html</code> 
                            dan masukkan <b>firebaseConfig</b> Anda.
                        </p>
                    </div>
                </div>
            );
        }

        // --- APLIKASI UTAMA ---
        function App() {
            const [view, setView] = useState('login');
            const [user, setUser] = useState(null);
            const [firebaseUser, setFirebaseUser] = useState(null);
            
            const [exams, setExams] = useState([]);
            const [results, setResults] = useState([]);
            const [violations, setViolations] = useState([]);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);

            if (!isConfigured) return <ConfigErrorScreen />;

            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try { await auth.signInAnonymously(); } 
                    catch(e) { console.error("Auth Fail:", e); }
                };
                initAuth();
                return auth.onAuthStateChanged((u) => setFirebaseUser(u));
            }, []);

            useEffect(() => {
                if (!firebaseUser || !db) return;
                setLoading(true);

                const handleErr = (src) => (err) => { console.warn(`${src} error:`, err); if(src==='Results') setLoading(false); };
                const basePath = db.collection('artifacts').doc(appId).collection('public').doc('data');
                
                const unsubExams = basePath.collection('exams').onSnapshot(s => setExams(s.docs.map(d => ({id: d.id, ...d.data()}))), handleErr('Exams'));
                const unsubResults = basePath.collection('results').onSnapshot(s => {
                    setResults(s.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                }, handleErr('Results'));
                const unsubViolations = basePath.collection('violations').onSnapshot(s => {
                    const vData = s.docs.map(d => ({id: d.id, ...d.data()}));
                    vData.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    setViolations(vData);
                }, handleErr('Violations'));

                return () => { unsubExams(); unsubResults(); unsubViolations(); };
            }, [firebaseUser]);

            const notify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const handleLogin = (role, userData) => {
                setUser({ ...userData, role });
                setView(role === 'admin' ? 'admin' : 'student');
                notify(`Selamat datang, ${userData.name}!`);
            };

            const handleLogout = () => { setUser(null); setView('login'); };

            const handleAddExam = async (data) => {
                try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('exams').add(data); notify("Paket soal tersimpan!"); } catch (e) { notify("Gagal simpan.", "error"); }
            };

            const handleDeleteExam = async (id) => {
                if(!confirm("Hapus paket ini?")) return;
                try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('exams').doc(id).delete(); notify("Paket dihapus."); } catch (e) { notify("Gagal hapus.", "error"); }
            };

            const handleSubmitResult = async (data) => {
                try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('results').add(data); return true; } catch (e) { notify("Gagal kirim nilai.", "error"); return false; }
            };

            const handleReportViolation = async (data) => {
                try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('violations').add({...data, timestamp: new Date().toISOString()}); } catch(e) { console.error(e); }
            };

            const handleResetData = async (collectionName) => {
                if (!db) return;
                const confirmMsg = collectionName === 'students' 
                    ? "PERINGATAN: Hapus SEMUA akun siswa? Siswa harus daftar ulang."
                    : `PERINGATAN: Hapus SEMUA data ${collectionName}?`;
                if (!confirm(confirmMsg)) return;

                setLoading(true);
                try {
                    const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
                    const snapshot = await ref.get();
                    
                    if (snapshot.size === 0) {
                        notify("Data sudah kosong.");
                        setLoading(false);
                        return;
                    }

                    // Hapus data dalam batch kecil (maks 400 per batch) untuk menghindari limit Firestore
                    const batchSize = 400;
                    let batch = db.batch();
                    let count = 0;
                    let batchCommits = [];

                    snapshot.docs.forEach((doc, i) => {
                        batch.delete(doc.ref);
                        count++;
                        if (count === batchSize) {
                            batchCommits.push(batch.commit());
                            batch = db.batch();
                            count = 0;
                        }
                    });

                    // Commit sisa data
                    if (count > 0) {
                        batchCommits.push(batch.commit());
                    }

                    // Tunggu semua proses selesai
                    await Promise.all(batchCommits);
                    notify(`Berhasil mereset ${snapshot.size} data ${collectionName}.`);

                } catch (e) { 
                    console.error("Reset Error:", e);
                    if (e.code === 'permission-denied') {
                        alert("GAGAL RESET: Izin ditolak oleh Firebase.\n\nSolusi: Buka Firebase Console > Firestore Database > Rules.\nUbah 'allow delete: if false' menjadi 'allow delete: if true'.");
                    } else {
                        notify("Gagal reset data. Cek koneksi.", "error"); 
                    }
                }
                setLoading(false);
            };

            // --- BACKUP DATA ---
            const handleBackupData = async () => {
                if(!db) return;
                setLoading(true);
                try {
                    const collections = ['exams', 'results', 'students', 'violations'];
                    const backupData = {};
                    for(const col of collections) {
                        const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(col).get();
                        backupData[col] = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }
                    const json = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([json], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `Backup_EduTKA_${new Date().toISOString().slice(0,10)}.json`; a.click();
                    notify("Backup data berhasil diunduh.");
                } catch(e) { console.error(e); notify("Gagal membuat backup.", "error"); }
                setLoading(false);
            };

            // --- RESTORE DATA ---
            const handleRestoreData = async (file) => {
                if(!db || !file) return;
                if(!confirm("PERINGATAN: Restore akan menimpa/menambah data ke database. Lanjutkan?")) return;
                setLoading(true);
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const collections = ['exams', 'results', 'students', 'violations'];
                        for(const col of collections) {
                            if(data[col] && Array.isArray(data[col])) {
                                for(const item of data[col]) {
                                    const { id, ...docData } = item;
                                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection(col).doc(id).set(docData);
                                }
                            }
                        }
                        notify("Data berhasil direstore!");
                    } catch(err) { console.error(err); notify("File backup tidak valid atau rusak.", "error"); }
                    setLoading(false);
                };
                reader.readAsText(file);
            };

            if (!firebaseUser && loading) return <div className="h-screen flex flex-col gap-4 items-center justify-center text-indigo-600 font-bold text-xl"><Icon name="loading" size={48} className="animate-spin"/><p>Menghubungkan ke EduTKA...</p></div>;

            return (
                <div className="min-h-screen">
                    {notification && (
                        <div className={`fixed top-5 right-5 z-50 px-6 py-3 rounded-xl shadow-2xl transform transition-all duration-300 flex items-center gap-3 border ${notification.type === 'error' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-emerald-50 text-emerald-600 border-emerald-200'}`}>
                            <Icon name={notification.type === 'error' ? 'alert' : 'check'}/>
                            <span className="font-bold">{notification.msg}</span>
                        </div>
                    )}

                    {view === 'login' && <LoginScreen onLogin={handleLogin} notify={notify} db={db} appId={appId} />}
                    {view === 'admin' && (
                        <AdminPortal 
                            user={user} onLogout={handleLogout} exams={exams} results={results} violations={violations} 
                            onAddExam={handleAddExam} onDeleteExam={handleDeleteExam} onResetData={handleResetData}
                            onBackup={handleBackupData} onRestore={handleRestoreData} notify={notify}
                        />
                    )}
                    {view === 'student' && (
                        <StudentPortal 
                            user={user} onLogout={handleLogout} exams={exams} results={results} 
                            onSubmitResult={handleSubmitResult} onReportViolation={handleReportViolation} notify={notify}
                        />
                    )}
                </div>
            );
        }

        // --- LOGIN SCREEN ---
        function LoginScreen({ onLogin, notify, db, appId }) {
            const [role, setRole] = useState('student');
            const [isRegister, setIsRegister] = useState(false);
            const [formData, setFormData] = useState({ id: '', name: '', password: '', class: '' }); 
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                if (role === 'admin') {
                    if (formData.id === INITIAL_ADMIN.username && formData.password === INITIAL_ADMIN.password) onLogin('admin', INITIAL_ADMIN);
                    else notify('Password Admin Salah', 'error');
                } else {
                    if (!formData.id || !formData.name) { notify("Lengkapi data", "error"); setLoading(false); return; }
                    const studentsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('students');
                    try {
                        const snapshot = await studentsRef.where("nis", "==", formData.id).get();
                        // CEK KUOTA PENDAFTAR (LIMIT 223)
                        const allStudentsSnap = await studentsRef.get(); 
                        if (isRegister && allStudentsSnap.size >= 223) {
                            notify("Pendaftaran PENUH! Kuota 223 siswa telah tercapai.", "error"); setLoading(false); return;
                        }
                        if (isRegister) {
                            if (!snapshot.empty) notify("NISN sudah terdaftar. Silakan login.", "error");
                            else { await studentsRef.add({ nis: formData.id, name: formData.name, class: formData.class }); notify("Berhasil daftar! Silakan login."); setIsRegister(false); }
                        } else {
                            if (snapshot.empty) notify("NISN belum terdaftar.", "error");
                            else {
                                const data = snapshot.docs[0].data();
                                if (data.name.toLowerCase() !== formData.name.toLowerCase()) notify("Nama tidak sesuai NISN.", "error");
                                else onLogin('student', { nis: formData.id, name: formData.name, class: data.class || '-' });
                            }
                        }
                    } catch (err) { notify("Gagal koneksi database", "error"); }
                }
                setLoading(false);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-indigo-900 p-4">
                    <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl w-full max-w-4xl flex flex-col md:flex-row overflow-hidden border border-white/10 animate-fade-in">
                        <div className="md:w-1/2 p-12 flex flex-col justify-center items-center text-white text-center bg-indigo-600/20">
                            <div className="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center mb-6 shadow-inner"><Icon name="book" size={48} className="text-white"/></div>
                            <h1 className="text-4xl font-bold mb-2">EduTKA Pro</h1>
                            <p className="text-indigo-200 text-lg">Platform Ujian Online Terintegrasi</p>
                        </div>
                        <div className="md:w-1/2 p-10 bg-white">
                            <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">{role === 'admin' ? 'Login Admin' : (isRegister ? 'Daftar Akun' : 'Login Siswa')}</h2>
                            <div className="flex bg-slate-100 p-1 rounded-lg mb-6">
                                <button onClick={() => setRole('student')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${role === 'student' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Siswa</button>
                                <button onClick={() => setRole('admin')} className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${role === 'admin' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Admin</button>
                            </div>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">{role === 'admin' ? 'Username' : 'NISN'}</label><input type="text" value={formData.id} onChange={e => setFormData({...formData, id: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" required placeholder={role === 'admin' ? 'admin' : 'Contoh: 12345'}/></div>
                                {role === 'admin' ? (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label><input type="password" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" required placeholder="***"/></div>) : (
                                    <>
                                        <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label><input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" required placeholder="Nama Siswa"/></div>
                                        {isRegister && (<div><label className="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label><input type="text" value={formData.class} onChange={e => setFormData({...formData, class: e.target.value})} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" required placeholder="Contoh: 9A"/></div>)}
                                    </>
                                )}
                                <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 shadow-lg shadow-indigo-200">{loading ? 'Memproses...' : (role === 'admin' ? 'Masuk Dashboard' : (isRegister ? 'Buat Akun Baru' : 'Masuk Ujian'))}</button>
                            </form>
                            {role === 'student' && (<p className="text-center mt-6 text-sm text-slate-500 cursor-pointer hover:text-indigo-600 font-medium" onClick={() => setIsRegister(!isRegister)}>{isRegister ? 'Sudah punya akun? Login' : 'Belum punya akun? Daftar'}</p>)}
                        </div>
                    </div>
                </div>
            );
        }

        // --- ADMIN PORTAL ---
        function AdminPortal({ user, onLogout, exams, results, violations, onAddExam, onDeleteExam, onResetData, onBackup, onRestore, notify }) {
            const [tab, setTab] = useState('dashboard');
            const [newExam, setNewExam] = useState(null);
            const restoreInputRef = useRef(null);

            const stats = useMemo(() => {
                const totalStudents = new Set(results.map(r => r.studentId)).size;
                const avgScore = results.length > 0 ? Math.round(results.reduce((a, b) => a + b.score, 0) / results.length) : 0;
                const passCount = results.filter(r => r.score >= 70).length;
                const passRate = results.length > 0 ? Math.round((passCount / results.length) * 100) : 0;
                return { totalExams: exams.length, totalStudents, avgScore, passRate, totalResults: results.length };
            }, [exams, results]);

            const downloadExcel = () => {
                const data = results.map(r => {
                    const vCount = violations.filter(v => v.studentId === r.studentId && v.examId === r.examId).length;
                    return {"Nama": r.studentName, "Kelas": r.studentClass || '-', "NISN": r.studentId, "Paket": r.examTitle, "Nilai": r.score, "Tanggal": r.date, "Status": r.score >= 70 ? "Lulus" : "Remedial", "Pelanggaran": vCount > 0 ? `${vCount}x` : "Aman"};
                });
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Laporan Nilai");
                XLSX.writeFile(wb, "Laporan_Nilai_TKA.xlsx");
            };

            return (
                <div className="flex h-screen overflow-hidden bg-slate-50">
                    <aside className="w-64 bg-white border-r border-slate-200 flex flex-col z-10">
                        <div className="p-6 border-b border-slate-100">
                            <div className="font-black text-2xl text-indigo-600 flex items-center gap-2"><Icon name="book" size={28}/> EduTKA</div>
                            <div className="text-xs text-slate-400 mt-1 uppercase font-bold tracking-wider">Admin Control</div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
                            {[{id: 'dashboard', label: 'Dashboard', icon: 'dashboard'}, {id: 'exams', label: 'Kelola Soal', icon: 'file'}, {id: 'results', label: 'Rekap Nilai', icon: 'users'}, {id: 'settings', label: 'Pengaturan', icon: 'settings'}].map(item => (
                                <button key={item.id} onClick={() => setTab(item.id)} className={`w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all ${tab === item.id ? 'bg-indigo-50 text-indigo-700 font-bold shadow-sm ring-1 ring-indigo-200' : 'text-slate-600 hover:bg-slate-50'}`}><Icon name={item.icon} size={18}/> {item.label}</button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-100"><button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-xl font-medium transition-colors"><Icon name="logout" size={18}/> Keluar</button></div>
                    </aside>
                    <main className="flex-1 overflow-auto bg-slate-50 relative">
                        <div className="h-48 bg-gradient-to-r from-indigo-600 to-purple-600 absolute top-0 left-0 w-full z-0"></div>
                        <div className="relative z-10 p-8">
                            <div className="mb-8 text-white flex justify-between items-end">
                                <div><h2 className="text-3xl font-bold">Halo, {user.name}</h2><p className="opacity-90">Berikut ringkasan aktivitas ujian hari ini.</p></div>
                                <div className="text-sm bg-white/20 backdrop-blur px-4 py-2 rounded-full font-medium">{new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                            </div>
                            {tab === 'dashboard' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        {[{ label: "Total Peserta", val: stats.totalStudents, icon: "users", color: "blue" }, { label: "Total Ujian", val: stats.totalExams, icon: "file", color: "purple" }, { label: "Rata-rata Nilai", val: stats.avgScore, icon: "trending", color: "orange" }, { label: "Tingkat Kelulusan", val: `${stats.passRate}%`, icon: "check", color: "emerald" }].map((s, i) => (
                                            <div key={i} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow"><div className={`w-14 h-14 rounded-full flex items-center justify-center bg-${s.color}-50 text-${s.color}-600`}><Icon name={s.icon} size={24}/></div><div><div className="text-slate-500 text-xs uppercase font-bold tracking-wider">{s.label}</div><div className="text-2xl font-bold text-slate-800">{s.val}</div></div></div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-96 flex flex-col">
                                            <h3 className="font-bold text-lg mb-6 flex items-center gap-2 text-slate-700"><Icon name="chart"/> Analisis Nilai (Live)</h3>
                                            <div className="flex-1 flex items-end gap-2 border-b border-l border-slate-100 p-4">
                                                {results.slice(0, 20).map((r, i) => (<div key={i} className="flex-1 bg-indigo-500 hover:bg-indigo-600 rounded-t relative group transition-all" style={{height: `${r.score}%`}}><div className="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">{r.studentName}: {r.score}</div></div>))}
                                                {results.length === 0 && <div className="w-full text-center text-slate-400 self-center">Belum ada data nilai masuk.</div>}
                                            </div>
                                        </div>
                                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-96">
                                            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-red-50/50"><h3 className="font-bold text-red-700 flex items-center gap-2"><Icon name="shield"/> Live Pelanggaran</h3><span className="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded-full">{violations.length}</span></div>
                                            <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                                {violations.length === 0 ? (<div className="h-full flex flex-col items-center justify-center text-slate-400 text-center text-sm p-6"><div className="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-500 mb-3"><Icon name="check" size={32}/></div><p>Tidak ada aktivitas mencurigakan.</p></div>) : (violations.map((v, i) => (<div key={i} className="p-3 rounded-xl bg-red-50 border border-red-100 text-sm"><div className="flex justify-between font-bold text-slate-800"><span className="truncate">{v.studentName}</span><span className="text-red-500 text-xs shrink-0">{new Date(v.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><div className="text-slate-500 text-xs mt-1">{v.type === 'switch_tab' ? 'Meninggalkan Aplikasi' : 'Perilaku Mencurigakan'}</div></div>)))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'results' && (
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 animate-fade-in">
                                    <div className="flex justify-between items-center mb-6">
                                        <div><h3 className="font-bold text-xl">Rekapitulasi Nilai</h3><p className="text-slate-500 text-sm">Daftar hasil ujian seluruh siswa.</p></div>
                                        <button onClick={downloadExcel} className="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-emerald-100 transition-all"><Icon name="download"/> Download Excel</button>
                                    </div>
                                    <div className="overflow-x-auto rounded-lg border border-slate-100">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs font-bold"><tr><th className="p-4">Nama Siswa</th><th className="p-4">Kelas</th><th className="p-4">Paket Soal</th><th className="p-4">Nilai</th><th className="p-4">Status</th><th className="p-4">Pelanggaran</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {results.map(r => {
                                                    const vCount = violations.filter(v => v.studentId === r.studentId && v.examId === r.examId).length;
                                                    return (<tr key={r.id} className="hover:bg-slate-50/50 transition-colors"><td className="p-4 font-medium text-slate-700">{r.studentName} <br/><span className="text-xs text-slate-400 font-normal">{r.studentId}</span></td><td className="p-4 text-slate-600">{r.studentClass || '-'}</td><td className="p-4 text-slate-500">{r.examTitle}</td><td className="p-4 font-bold text-lg text-indigo-600">{r.score}</td><td className="p-4"><span className={`px-3 py-1 rounded-full text-xs font-bold ${r.score >= 70 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{r.score >= 70 ? 'Lulus' : 'Remedial'}</span></td><td className="p-4">{vCount > 0 ? <span className="bg-red-50 text-red-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 w-fit border border-red-100"><Icon name="alert" size={14}/> {vCount}x</span> : <span className="text-emerald-500 flex items-center gap-1 text-xs font-medium"><Icon name="check" size={14}/> Bersih</span>}</td></tr>);
                                                })}
                                                {results.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-400 italic">Belum ada data nilai.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {tab === 'exams' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {exams.map(e => (
                                            <div key={e.id} className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all group relative">
                                                <div className="flex justify-between items-start mb-4"><div className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-lg flex items-center justify-center"><Icon name="file"/></div><button onClick={() => onDeleteExam(e.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="trash"/></button></div>
                                                <h3 className="font-bold text-lg text-slate-800 mb-1">{e.title}</h3><p className="text-sm text-slate-500 mb-4">Kode: <span className="font-mono bg-slate-100 px-1 rounded text-slate-600">{e.code}</span></p>
                                                <div className="flex items-center gap-4 text-xs text-slate-400 font-medium"><span className="flex items-center gap-1"><Icon name="clock" size={14}/> {e.duration} Menit</span><span className="flex items-center gap-1"><Icon name="file" size={14}/> {e.questions.length} Soal</span></div>
                                            </div>
                                        ))}
                                        <button onClick={() => setNewExam({ title: '', code: '', duration: 60, questions: [] })} className="bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center p-6 text-slate-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-indigo-50/50 transition-all min-h-[200px]"><div className="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mb-3"><Icon name="plus" size={24}/></div><span className="font-bold">Buat Paket Baru</span></button>
                                    </div>
                                    {newExam && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in"><div className="w-full max-w-4xl max-h-[90vh] overflow-y-auto custom-scrollbar"><ExamEditor exam={newExam} onSave={(e) => { onAddExam(e); setNewExam(null); }} onCancel={() => setNewExam(null)} notify={notify}/></div></div>)}
                                </div>
                            )}

                            {tab === 'settings' && (
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-8 animate-fade-in max-w-3xl mx-auto">
                                    <h2 className="font-bold text-2xl mb-2 text-slate-800">Pengaturan Data</h2><p className="text-slate-500 mb-8">Kelola dan bersihkan data sistem.</p>
                                    <div className="space-y-6">
                                        <div className="p-6 bg-indigo-50 rounded-xl border border-indigo-100">
                                            <h3 className="font-bold text-indigo-800 flex items-center gap-2 mb-2"><Icon name="db"/> Backup & Restore</h3><p className="text-sm text-indigo-600/80 mb-6">Unduh data untuk cadangan atau pulihkan dari file JSON.</p>
                                            <div className="flex gap-4"><button onClick={onBackup} className="flex-1 bg-white border border-indigo-200 text-indigo-600 px-4 py-3 rounded-lg text-sm hover:bg-indigo-100 font-bold transition-colors flex items-center justify-center gap-2"><Icon name="download"/> Download Backup</button><button onClick={() => restoreInputRef.current.click()} className="flex-1 bg-indigo-600 text-white px-4 py-3 rounded-lg text-sm hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-200 transition-colors flex items-center justify-center gap-2"><Icon name="upload"/> Restore Data</button><input type="file" ref={restoreInputRef} onChange={(e) => onRestore(e.target.files[0])} hidden accept=".json" /></div>
                                        </div>
                                        <div className="p-6 bg-red-50 rounded-xl border border-red-100">
                                            <h3 className="font-bold text-red-800 flex items-center gap-2 mb-2"><Icon name="alert"/> Zona Berbahaya</h3><p className="text-sm text-red-600/80 mb-6">Tindakan ini bersifat permanen dan tidak dapat dibatalkan.</p>
                                            <div className="space-y-4">
                                                <div className="flex justify-between items-center p-4 bg-white rounded-lg border border-red-100"><div><div className="font-bold text-slate-800">Reset Nilai Ujian</div><div className="text-xs text-slate-500">Hapus {results.length} data nilai.</div></div><button onClick={() => onResetData('results')} className="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm hover:bg-red-50 font-bold transition-colors">Hapus</button></div>
                                                <div className="flex justify-between items-center p-4 bg-white rounded-lg border border-red-100"><div><div className="font-bold text-slate-800">Reset Log Pelanggaran</div><div className="text-xs text-slate-500">Hapus {violations.length} log.</div></div><button onClick={() => onResetData('violations')} className="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-sm hover:bg-red-50 font-bold transition-colors">Hapus</button></div>
                                                <div className="flex justify-between items-center p-4 bg-white rounded-lg border border-red-100"><div><div className="font-bold text-slate-800">Reset Akun Siswa</div><div className="text-xs text-slate-500">Hapus semua akun terdaftar.</div></div><button onClick={() => onResetData('students')} className="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 font-bold shadow-lg shadow-red-200 transition-colors">Hapus Semua</button></div>
                                            </div>
                                        </div>
                                        <div className="text-xs text-center text-slate-400 font-mono pt-4">App ID: {appId} â€¢ v2.0 Pro</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        // --- COMPONENT EDITOR ---
        function ExamEditor({ exam, onSave, onCancel, notify }) {
            const [data, setData] = useState(exam);
            const [qIndex, setQIndex] = useState(null);
            const fileInputRef = useRef(null);

            const downloadTemplate = () => {
                const ws_data = [["Tipe (single/complex/truth/agree/relevant)", "Pertanyaan", "URL Gambar", "Opsi A", "Opsi B", "Opsi C", "Opsi D", "Jawaban Benar (1,2,3,4)"], ["single", "Apa ibukota Indonesia?", "", "Bandung", "Jakarta", "Surabaya", "Medan", "2"], ["truth", "Pilih Benar/Salah", "", "Pernyataan 1", "Pernyataan 2", "Pernyataan 3", "Pernyataan 4", "1,3"], ["agree", "Pilih Setuju/Tidak", "", "Pernyataan A", "Pernyataan B", "", "", "1"]];
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!cols'] = [{wch:25}, {wch:40}, {wch:20}, {wch:15}, {wch:15}, {wch:15}, {wch:15}, {wch:25}];
                XLSX.utils.book_append_sheet(wb, ws, "Template");
                XLSX.writeFile(wb, "Template_Soal.xlsx");
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'array' });
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        const newQs = [];
                        for(let i=1; i<json.length; i++) {
                            const row = json[i];
                            if(!row || row.length < 2) continue; 
                            let type = 'single';
                            const t = (row[0]||'').toString().toLowerCase();
                            if(t.includes('complex')) type='complex';
                            else if(t.includes('truth')) type='truth';
                            else if(t.includes('agree')) type='agree';
                            else if(t.includes('relevant')) type='relevant';
                            
                            const correctIndices = (row[7] || '').toString().split(/[\s,]+/).map(x=>parseInt(x)).filter(x=>!isNaN(x));
                            newQs.push({
                                id: Date.now() + i, type: type,
                                text: row[1] || '', image: row[2] || '',
                                options: [1,2,3,4].map(idx => ({ id: idx, text: (row[2+idx]||'').toString(), isCorrect: correctIndices.includes(idx), image: '' }))
                            });
                        }
                        setData(prev => ({ ...prev, questions: [...prev.questions, ...newQs] }));
                        notify(`Berhasil impor ${newQs.length} soal!`);
                    } catch(err) { notify("Gagal baca Excel.", "error"); }
                };
                reader.readAsArrayBuffer(file);
                e.target.value = null;
            };

            const addQ = () => { setData({ ...data, questions: [...data.questions, { id: Date.now(), text: '', type: 'single', image: '', options: [{id:1, text:'', isCorrect:false, image:''},{id:2, text:'', isCorrect:false, image:''},{id:3, text:'', isCorrect:false, image:''},{id:4, text:'', isCorrect:false, image:''}] }] }); setQIndex(data.questions.length); };
            const updateQ = (idx, field, val) => { const qs = [...data.questions]; qs[idx][field] = val; setData({...data, questions: qs}); };
            const updateOpt = (qIdx, oIdx, field, val) => { const qs = [...data.questions]; qs[qIdx].options[oIdx][field] = val; setData({...data, questions: qs}); };
            const toggleCorrect = (qIdx, oIdx) => { 
                const qs = [...data.questions]; 
                const type = qs[qIdx].type;
                if (type === 'single') qs[qIdx].options.forEach((o, i) => o.isCorrect = i === oIdx); 
                else if (['truth','agree','relevant'].includes(type)) qs[qIdx].options[oIdx].isCorrect = !qs[qIdx].options[oIdx].isCorrect; 
                else qs[qIdx].options[oIdx].isCorrect = !qs[qIdx].options[oIdx].isCorrect; 
                setData({...data, questions: qs}); 
            };

            if (qIndex !== null) {
                const q = data.questions[qIndex];
                const getColHeader = (t) => {
                    if(t==='truth') return 'Benar';
                    if(t==='agree') return 'Setuju';
                    if(t==='relevant') return 'Relevan';
                    return 'Benar';
                }

                return (
                    <div className="bg-white p-6 rounded-2xl shadow-xl animate-fade-in">
                        <div className="flex flex-wrap justify-between font-bold mb-4 items-center gap-2">
                            <span className="text-lg">Edit Soal #{qIndex+1}</span> 
                            <button onClick={() => setQIndex(null)} className="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 transition-colors">Selesai</button>
                        </div>
                        <div className="space-y-4">
                            <select value={q.type} onChange={e => updateQ(qIndex, 'type', e.target.value)} className="p-3 border rounded-xl w-full bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="single">Pilihan Ganda Tunggal</option>
                                <option value="complex">Pilihan Ganda Kompleks</option>
                                <option value="truth">PG Kompleks - Benar/Salah</option>
                                <option value="agree">PG Kompleks - Setuju/Tidak Setuju</option>
                                <option value="relevant">PG Kompleks - Relevan/Tidak Relevan</option>
                            </select>
                            <textarea value={q.text} onChange={e => updateQ(qIndex, 'text', e.target.value)} className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Tulis pertanyaan disini..." rows={3}/>
                            <div className="flex flex-col sm:flex-row gap-2">
                                <input value={q.image || ''} onChange={e => updateQ(qIndex, 'image', e.target.value)} className="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Link Gambar Soal (Opsional)..." />
                                {q.image && <img src={q.image} className="h-12 w-12 object-cover rounded-lg border bg-slate-50"/>}
                            </div>
                            <div className="space-y-3 pt-2">
                                <p className="text-xs font-bold text-slate-400 uppercase">
                                    {['truth','agree','relevant'].includes(q.type) ? `Pernyataan (${getColHeader(q.type)}?)` : 'Pilihan Jawaban'}
                                </p>
                                {q.options.map((opt, i) => (
                                    <div key={i} className="flex flex-col sm:flex-row items-start sm:items-center gap-3 border p-3 rounded-lg bg-slate-50/50">
                                        <button onClick={() => toggleCorrect(qIndex, i)} className={`w-8 h-8 rounded-full border flex items-center justify-center transition-all shrink-0 ${opt.isCorrect ? 'bg-emerald-500 text-white border-emerald-500 shadow-md shadow-emerald-200' : 'bg-white hover:bg-slate-50'}`} title={opt.isCorrect ? "Jawaban Benar" : "Tandai Benar"}>{opt.isCorrect && <Icon name="check" size={16}/>}</button>
                                        <div className="flex-1 w-full space-y-2">
                                            <input value={opt.text} onChange={e => updateOpt(qIndex, i, 'text', e.target.value)} className="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder={`Opsi ${String.fromCharCode(65+i)}`}/>
                                            <input value={opt.image || ''} onChange={e => updateOpt(qIndex, i, 'image', e.target.value)} className="w-full p-2 border rounded-lg text-xs text-slate-500 focus:ring-1 focus:ring-indigo-300 outline-none" placeholder="Link Gambar Opsi (Opsional)..."/>
                                        </div>
                                        {opt.image && <img src={opt.image} className="h-10 w-10 object-cover rounded border bg-white self-center sm:self-start"/>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-white p-8 rounded-2xl shadow-xl animate-fade-in">
                    <h3 className="font-bold text-xl mb-6 flex items-center gap-2"><Icon name="file"/> Editor Paket Soal</h3>
                    <div className="space-y-4 mb-6">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Judul Paket</label>
                            <input value={data.title} onChange={e => setData({...data, title: e.target.value})} className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Contoh: Try Out Matematika 1" />
                        </div>
                        <div className="flex flex-col sm:flex-row gap-4">
                            <div className="flex-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Kode Unik</label>
                                <input value={data.code} onChange={e => setData({...data, code: e.target.value})} className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none font-mono" placeholder="MTK-01" />
                            </div>
                            <div className="w-full sm:w-32">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Durasi (Menit)</label>
                                <input type="number" value={data.duration} onChange={e => setData({...data, duration: parseInt(e.target.value)})} className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </div>
                        </div>
                    </div>
                    <div className="border-t border-slate-100 pt-6">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                            <div className="font-bold text-slate-700">Daftar Soal ({data.questions.length})</div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <button onClick={downloadTemplate} className="flex-1 sm:flex-none justify-center text-xs bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg hover:bg-emerald-100 flex items-center gap-2 font-medium transition-colors"><Icon name="download" size={14}/> Template</button>
                                <button onClick={() => fileInputRef.current.click()} className="flex-1 sm:flex-none justify-center text-xs bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-100 flex items-center gap-2 font-medium transition-colors"><Icon name="upload" size={14}/> Import Excel</button>
                                <input type="file" ref={fileInputRef} onChange={handleImport} hidden accept=".xlsx, .xls" />
                            </div>
                        </div>
                        <div className="space-y-2 mb-6 max-h-80 overflow-auto custom-scrollbar pr-2 bg-slate-50 p-2 rounded-xl border border-slate-100">
                            {data.questions.map((q, i) => (
                                <div key={i} className="group relative p-3 bg-white border border-slate-200 rounded-lg hover:shadow-md transition-all flex justify-between items-center">
                                    <div onClick={() => setQIndex(i)} className="cursor-pointer truncate flex-1 flex items-center gap-3 pr-2">
                                        <span className="w-6 h-6 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center text-xs font-bold shrink-0">{i+1}</span>
                                        <span className="text-sm text-slate-600 truncate">{q.text}</span>
                                    </div>
                                    <button onClick={() => setData(prev => ({...prev, questions: prev.questions.filter((_, idx) => idx !== i)}))} className="text-slate-300 hover:text-red-500 transition-colors px-2 shrink-0"><Icon name="x" size={16}/></button>
                                </div>
                            ))}
                            {data.questions.length === 0 && <div className="text-center text-slate-400 py-8 italic flex flex-col items-center"><Icon name="file" size={32} className="mb-2 opacity-50"/>Belum ada soal.</div>}
                        </div>
                        <button onClick={addQ} className="w-full py-3 border-2 border-dashed border-indigo-200 text-indigo-600 rounded-xl text-sm font-bold hover:bg-indigo-50 hover:border-indigo-300 transition-all flex items-center justify-center gap-2"><Icon name="plus" size={18}/> Tambah Soal Manual</button>
                    </div>
                    <div className="flex gap-4 pt-8 mt-4 border-t border-slate-100">
                        <button onClick={onCancel} className="flex-1 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition-colors">Batal</button>
                        <button onClick={() => onSave(data)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors">Simpan Paket</button>
                    </div>
                </div>
            );
        }

        // --- STUDENT PORTAL ---
        function StudentPortal({ user, onLogout, exams, results, onSubmitResult, onReportViolation, notify }) {
            const [mode, setMode] = useState('list');
            const [examCode, setExamCode] = useState('');
            const [activeExam, setActiveExam] = useState(null);

            const start = () => {
                const found = exams.find(e => e.code === examCode);
                if (!found) return notify("Kode ujian tidak ditemukan.", "error");
                if (results.some(r => r.studentId === user.nis && r.examId === found.id)) return notify("Anda sudah mengerjakan ujian ini.", "error");
                setActiveExam(found);
                setMode('run');
            };

            if (mode === 'run') return <ExamRunner user={user} exam={activeExam} onReport={onReportViolation} onFinish={async (score) => {
                const success = await onSubmitResult({ studentId: user.nis, studentName: user.name, studentClass: user.class, examId: activeExam.id, examTitle: activeExam.title, score, date: new Date().toLocaleDateString() });
                if (success) setMode('done');
            }} />;

            if (mode === 'done') return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-50 to-white p-4">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full border border-slate-100 animate-fade-in">
                        <div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner"><Icon name="check" size={40}/></div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Ujian Selesai!</h2>
                        <p className="text-slate-500 mb-8 text-sm">Jawaban Anda telah berhasil disimpan ke sistem.</p>
                        <button onClick={() => setMode('list')} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition-colors">Kembali ke Beranda</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50">
                    <nav className="bg-white shadow-sm border-b border-slate-100 px-6 py-4 flex justify-between items-center sticky top-0 z-20">
                        <div className="font-bold text-indigo-600 flex items-center gap-2 text-lg"><Icon name="book"/> EduTKA</div>
                        <div className="flex gap-4 items-center">
                            <span className="text-sm font-bold text-slate-600 hidden md:block">Halo, {user.name}</span>
                            <button onClick={onLogout} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors"><Icon name="logout"/></button>
                        </div>
                    </nav>
                    <div className="max-w-3xl mx-auto p-6 space-y-8">
                        <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-3xl p-10 text-white shadow-xl shadow-indigo-200 relative overflow-hidden animate-fade-in">
                            <div className="relative z-10 max-w-lg">
                                <h2 className="text-3xl font-bold mb-2">Siap untuk Ujian?</h2>
                                <p className="text-indigo-100 mb-8">Masukkan kode unik yang diberikan guru untuk memulai.</p>
                                <div className="flex gap-3">
                                    <input value={examCode} onChange={e => setExamCode(e.target.value)} className="flex-1 p-4 rounded-xl text-slate-800 outline-none shadow-lg border-0" placeholder="Kode Ujian (Contoh: MTK-01)" />
                                    <button onClick={start} className="bg-white text-indigo-700 font-bold px-8 rounded-xl hover:bg-indigo-50 shadow-lg transition-colors flex items-center gap-2">Mulai <Icon name="settings" size={18} className="rotate-90"/></button>
                                </div>
                            </div>
                            <div className="absolute -right-10 -bottom-10 opacity-10 transform rotate-12 scale-150"><Icon name="file" size={200}/></div>
                        </div>

                        <div className="space-y-4">
                            <h3 className="font-bold text-slate-800 text-lg px-2">Riwayat Ujian Anda</h3>
                            <div className="grid gap-4">
                                {results.filter(r => r.studentId === user.nis).map(r => (
                                    <div key={r.id} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex justify-between items-center hover:shadow-md transition-all">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 font-bold border border-slate-200"><Icon name="file"/></div>
                                            <div>
                                                <div className="font-bold text-slate-800 text-lg">{r.examTitle}</div>
                                                <div className="text-xs text-slate-500 font-medium">{r.date}</div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-3xl font-black text-indigo-600">{r.score}</div>
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider">Nilai</div>
                                        </div>
                                    </div>
                                ))}
                                {results.filter(r => r.studentId === user.nis).length === 0 && (
                                    <div className="text-center py-12 text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">
                                        <div className="mx-auto w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3 text-slate-300"><Icon name="file" size={32}/></div>
                                        Belum ada riwayat ujian.
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- RUNNER UJIAN ---
        function ExamRunner({ user, exam, onReport, onFinish }) {
            const [ans, setAns] = useState({});
            const [time, setTime] = useState(exam.duration * 60);
            const [submitting, setSubmitting] = useState(false);
            const violationCountRef = useRef(0);

            useEffect(() => {
                const handleVis = () => { 
                    if (document.hidden) { 
                        violationCountRef.current += 1;
                        const currentCount = violationCountRef.current;
                        
                        onReport({ type: 'switch_tab', studentId: user.nis, studentName: user.name, studentClass: user.class, examId: exam.id, examTitle: exam.title }); 
                        
                        if (currentCount >= 3) {
                            alert("PELANGGARAN TERAKHIR! Sistem mendeteksi Anda keluar aplikasi sebanyak 3 kali. Ujian akan dihentikan dan jawaban dikumpulkan otomatis.");
                            submit(); 
                        } else {
                            alert(`PERINGATAN PELANGGARAN (${currentCount}/3)!\n\nAnda terdeteksi keluar dari aplikasi ujian.\nJika mencapai 3 kali, ujian akan dihentikan paksa.`);
                        }
                    } 
                };
                document.addEventListener("visibilitychange", handleVis); 
                return () => document.removeEventListener("visibilitychange", handleVis);
            }, []);

            useEffect(() => {
                const t = setInterval(() => { setTime(prev => { if (prev <= 1) { clearInterval(t); submit(); return 0; } return prev - 1; }); }, 1000);
                return () => clearInterval(t);
            }, []);

            const select = (qId, type, optId) => {
                const cur = ans[qId] || [];
                if (type === 'single') setAns({ ...ans, [qId]: [optId] });
                else if (['truth','agree','relevant'].includes(type)) setAns({ ...ans, [qId]: cur.includes(optId) ? cur.filter(i => i !== optId) : [...cur, optId] });
                else setAns({ ...ans, [qId]: cur.includes(optId) ? cur.filter(i => i !== optId) : [...cur, optId] });
            };

            const submit = async () => {
                if (!submitting) {
                    setSubmitting(true);
                    let correct = 0;
                    exam.questions.forEach(q => {
                        const uAns = ans[q.id] || []; const kAns = q.options.filter(o => o.isCorrect).map(o => o.id);
                        if (q.type === 'single' && uAns[0] === kAns[0]) correct++;
                        else if (q.type === 'complex' && JSON.stringify(uAns.sort()) === JSON.stringify(kAns.sort())) correct++;
                        else if (['truth','agree','relevant'].includes(q.type) && JSON.stringify(uAns.sort()) === JSON.stringify(kAns.sort())) correct++;
                    });
                    await onFinish(Math.round((correct / exam.questions.length) * 100));
                }
            };

            const getColHeader = (t) => {
                if(t==='truth') return 'Benar?';
                if(t==='agree') return 'Setuju?';
                if(t==='relevant') return 'Relevan?';
                return 'Pilih';
            }

            return (
                <div className="flex flex-col h-screen bg-slate-50">
                    <div className="bg-white px-6 py-4 shadow-sm border-b border-slate-200 flex justify-between items-center sticky top-0 z-30">
                        <div>
                            <div className="font-bold text-slate-800 text-lg truncate max-w-xs">{exam.title}</div>
                            <div className="text-xs text-slate-500 font-medium">Siswa: {user.name}</div>
                        </div>
                        <div className={`font-mono font-bold text-2xl bg-slate-100 px-4 py-2 rounded-lg border border-slate-200 ${time < 60 ? 'text-red-600 bg-red-50 border-red-200 animate-pulse' : 'text-slate-700'}`}>
                            {Math.floor(time/60)}:{(time%60).toString().padStart(2,'0')}
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-auto p-6 max-w-4xl mx-auto w-full space-y-8 pb-20">
                        <div className="bg-red-50 border border-red-200 text-red-800 text-sm p-4 rounded-xl flex items-start gap-3 shadow-sm">
                            <Icon name="shield" size={20} className="mt-0.5 text-red-600 shrink-0"/>
                            <div>
                                <strong className="block mb-1 text-red-700">Mode Ujian Aman Aktif</strong>
                                Dilarang berpindah tab atau membuka aplikasi lain. 
                                <br/>Pelanggaran ke-3 akan menyebabkan ujian terkunci otomatis.
                            </div>
                        </div>

                        {exam.questions.map((q, i) => (
                            <div key={q.id} className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                                <div className="flex gap-5 mb-6">
                                    <div className="bg-indigo-600 text-white w-10 h-10 flex items-center justify-center rounded-lg font-bold text-lg shrink-0 shadow-lg shadow-indigo-200">{i+1}</div>
                                    <div className="flex-1">
                                        <p className="text-lg font-medium text-slate-800 leading-relaxed">{q.text}</p>
                                        {q.image && <img src={q.image} className="mt-4 rounded-xl border border-slate-100 max-h-80 object-contain shadow-sm" />}
                                    </div>
                                </div>
                                <div className="space-y-3 pl-14">
                                    {['truth','agree','relevant'].includes(q.type) ? (
                                        <div className="grid gap-2">
                                            <div className="grid grid-cols-4 font-bold text-sm bg-slate-100 p-3 rounded-t-lg">
                                                <div className="col-span-3">Pernyataan</div>
                                                <div className="text-center">{getColHeader(q.type)}</div>
                                            </div>
                                            {q.options.map(opt => {
                                                const isMarked = (ans[q.id] || []).includes(opt.id);
                                                return (
                                                    <div key={opt.id} className="grid grid-cols-4 items-center border-b p-3 last:border-0 hover:bg-slate-50">
                                                        <div className="col-span-3 text-sm flex items-center gap-3">
                                                            {opt.image && <img src={opt.image} className="h-10 w-10 object-cover rounded border bg-white"/>}
                                                            <span>{opt.text}</span>
                                                        </div>
                                                        <div className="flex justify-center">
                                                            <button onClick={() => select(q.id, q.type, opt.id)} className={`w-6 h-6 rounded border flex items-center justify-center transition-all ${isMarked ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white'}`}>
                                                                {isMarked && <Icon name="check" size={14}/>}
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    ) : (
                                        q.options.map(opt => {
                                            const sel = (ans[q.id] || []).includes(opt.id);
                                            return (
                                                <div key={opt.id} onClick={() => select(q.id, q.type, opt.id)} className={`p-4 border-2 rounded-xl cursor-pointer flex items-center gap-4 transition-all ${sel ? 'bg-indigo-50 border-indigo-600 shadow-md ring-1 ring-indigo-600' : 'border-slate-100 hover:bg-slate-50 hover:border-slate-300'}`}>
                                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors shrink-0 ${sel ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-slate-300'}`}>
                                                        {sel && <div className="w-2.5 h-2.5 bg-white rounded-full"/>}
                                                    </div>
                                                    <div className="flex-1">
                                                        {opt.image && <img src={opt.image} className="mb-2 max-h-32 rounded border bg-white"/>}
                                                        <span className="text-slate-700 font-medium">{opt.text}</span>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-4 z-20">
                        <div className="max-w-4xl mx-auto">
                            <button onClick={() => { if(confirm("Kumpulkan jawaban sekarang?")) submit(); }} disabled={submitting} className="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 disabled:bg-slate-300 disabled:shadow-none transition-all flex justify-center items-center gap-2">
                                {submitting ? <><Icon name="loading" className="animate-spin"/> Mengirim Jawaban...</> : "Selesai & Kumpulkan Jawaban"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
